version: '3.9'

services:
  # POSTGRES
  postgres:
    image: postgres:16
    container_name: postgres_teacher_api
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

  # KEYCLOAK
  keycloak:
    image: quay.io/keycloak/keycloak:24.0.5
    container_name: keycloak_teacher_api
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    command: ["start-dev", "--http-enabled=true", "--http-port=8080"]
    volumes:
      - ./k-provider:/opt/keycloak/providers

  # REDPANDA (Kafka)
  kafka:
    image: redpandadata/redpanda:v23.2.14
    container_name: kafka
    command: >
      redpanda start
      --overprovisioned
      --smp 1
      --memory 1G
      --reserve-memory 0M
      --node-id 0
      --check=false
      --kafka-addr PLAINTEXT://0.0.0.0:9092,PLAINTEXT_INTERNAL://0.0.0.0:29092
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      REDPANDA_KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://46.62.248.137:9092,PLAINTEXT_INTERNAL://kafka:29092
    volumes:
      - redpanda_data:/var/lib/redpanda/data
    networks:
      - backend-network

  # REDPANDA CONSOLE
  kafka-ui:
    image: docker.redpanda.com/redpandadata/console:v2.5.0
    container_name: kafka-ui
    restart: unless-stopped
    ports:
      - "8081:8080"
    depends_on:
      - kafka
    environment:
      KAFKA_BROKERS: kafka:29092
    networks:
      - backend-network

  # BACKEND
  backend:
    image: ghcr.io/23serikk0z/teacher-api:latest
    container_name: teach-back
    ports:
      - "8888:8888"
    depends_on:
      - keycloak
      - postgres
      - kafka
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/animal
      SPRING_DATASOURCE_USERNAME: animal
      SPRING_DATASOURCE_PASSWORD: animal
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks:
      - backend-network

volumes:
  postgres_data:
  redpanda_data:

networks:
  backend-network:
    driver: bridge
